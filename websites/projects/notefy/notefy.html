<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <title>Notefy</title>
    <meta name="description" content="Deine pers√∂nliche Notizen App">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Notefy">
    <link rel="apple-touch-icon" href="notefy-app-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="notefy-app-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="notefy-app-icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="notefy-app-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="notefy-app-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="notefy-app-icon.png">
    <link rel="manifest" href="manifest.json">
    <!-- Use central designer stylesheet -->
    <link rel="stylesheet" href="../../../css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Notefy</h1>
            <p class="subtitle">Deine pers√∂nliche Notizen-App mit Style</p>
        </header>

        <div id="installPrompt" class="install-prompt glass-card" style="display: none;">
            <p style="margin-bottom: 16px;">üì± Installiere Notefy als App f√ºr schnellen Zugriff!</p>
            <button onclick="installApp()">Jetzt installieren</button>
        </div>

        <div class="status" id="status">
            <span class="status-indicator"></span>
            <span id="statusText">Online - Bereit zum Notieren</span>
        </div>

        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('notes')">üìù Notizen</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Einstellungen</button>
        </nav>

        <!-- Notizen Page -->
        <div id="notesPage" class="page-view active">
            <div class="controls">
                <button onclick="showEditor()">‚úèÔ∏è Neue Notiz</button>
                <button class="btn-secondary" onclick="exportNotes()">üì§ Exportieren</button>
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()">üì• Importieren</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importNotes(event)">
            </div>

            <div class="glass-card" id="editor" style="display: none; margin-bottom: 24px;">
                <h2 style="margin-bottom: 20px; color: var(--primary);">Notiz bearbeiten</h2>
                <input type="text" id="noteTitle" placeholder="Titel deiner Notiz...">
                <textarea id="noteContent" placeholder="Schreibe deine Gedanken hier nieder..."></textarea>
                <div style="display: flex; gap: 12px;">
                    <button onclick="saveNote()">üíæ Speichern</button>
                    <button class="btn-secondary" onclick="cancelEdit()">‚úñÔ∏è Abbrechen</button>
                </div>
            </div>

            <div class="notes-grid" id="notesGrid"></div>
        </div>

        <!-- Einstellungen Page -->
        <div id="settingsPage" class="page-view">
            <div class="glass-card settings-section">
                <h3>üé® Darstellung</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Dark Mode</h4>
                        <p>Dunkles Design f√ºr deine Augen</p>
                    </div>
                    <div class="toggle" id="darkModeToggle" onclick="toggleDarkMode()"></div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Akzentfarbe</h4>
                        <p>W√§hle deine Lieblingsfarbe</p>
                    </div>
                </div>
                <div class="color-options">
                    <div class="color-option active" data-primary="#6750A4" style="background: linear-gradient(135deg, #6750A4, #9980D1);" onclick="changeAccentColor(this)"></div>
                    <div class="color-option" data-primary="#B00020" style="background: linear-gradient(135deg, #B00020, #FF5252);" onclick="changeAccentColor(this)"></div>
                    <div class="color-option" data-primary="#018786" style="background: linear-gradient(135deg, #018786, #4DB6AC);" onclick="changeAccentColor(this)"></div>
                    <div class="color-option" data-primary="#6200EE" style="background: linear-gradient(135deg, #6200EE, #9D46FF);" onclick="changeAccentColor(this)"></div>
                    <div class="color-option" data-primary="#FF6F00" style="background: linear-gradient(135deg, #FF6F00, #FFB300);" onclick="changeAccentColor(this)"></div>
                    <div class="color-option" data-primary="#2E7D32" style="background: linear-gradient(135deg, #2E7D32, #66BB6A);" onclick="changeAccentColor(this)"></div>
                </div>
            </div>

            <div class="glass-card settings-section">
                <h3>‚úçÔ∏è Editor</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Schriftgr√∂√üe</h4>
                        <p id="fontSizeLabel">16px</p>
                    </div>
                </div>
                <input type="range" id="fontSizeRange" min="12" max="24" value="16" step="1" oninput="changeFontSize(this.value)">

                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Monospace-Font</h4>
                        <p>Code-Schriftart f√ºr Notizen</p>
                    </div>
                    <div class="toggle" id="monoToggle" onclick="toggleMonospace()"></div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Zeilenh√∂he</h4>
                        <p id="lineHeightLabel">1.6</p>
                    </div>
                </div>
                <input type="range" id="lineHeightRange" min="1.2" max="2.4" value="1.6" step="0.2" oninput="changeLineHeight(this.value)">
            </div>

            <div class="glass-card settings-section">
                <h3>üìä Notizen-Ansicht</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Spaltenanzahl</h4>
                        <p id="columnsLabel">Automatisch</p>
                    </div>
                </div>
                <select id="columnsSelect" onchange="changeColumns(this.value)">
                    <option value="auto">Automatisch</option>
                    <option value="1">1 Spalte</option>
                    <option value="2">2 Spalten</option>
                    <option value="3">3 Spalten</option>
                    <option value="4">4 Spalten</option>
                </select>

                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Kompakte Ansicht</h4>
                        <p>Kleinere Karten f√ºr mehr √úbersicht</p>
                    </div>
                    <div class="toggle" id="compactToggle" onclick="toggleCompactView()"></div>
                </div>
            </div>

            <div class="glass-card settings-section">
                <h3>üíæ Daten</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Gespeicherte Notizen</h4>
                        <p id="noteCount">0 Notizen</p>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Alle Notizen l√∂schen</h4>
                        <p>Unwiderruflich alle Notizen entfernen</p>
                    </div>
                    <button class="btn-secondary" onclick="clearAllNotes()" style="width: auto;">üóëÔ∏è Alle l√∂schen</button>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <h4>Einstellungen zur√ºcksetzen</h4>
                        <p>Auf Standardeinstellungen zur√ºcksetzen</p>
                    </div>
                    <button class="btn-secondary" onclick="resetSettings()" style="width: auto;">üîÑ Zur√ºcksetzen</button>
                </div>
            </div>

            <div class="glass-card" style="text-align: center;">
                <p style="color: var(--on-surface-variant); margin-bottom: 8px;">Notefy v1.0</p>
                <p style="color: var(--on-surface-variant); font-size: 0.85em;">Made with üíú by Farin</p>
            </div>
        </div>
    </div>

    <script>
const STORAGE_KEY = 'notefy_notes';
let currentEditId = null;
let deferredPrompt = null;

document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
    loadNotes();
    loadSettings();
    setupPWA();
    registerServiceWorker();
    checkOnlineStatus();
    updateNoteCount();
    window.addEventListener('online', checkOnlineStatus);
    window.addEventListener('offline', checkOnlineStatus);
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.page-view').forEach(view => view.classList.remove('active'));
    if (tab === 'notes') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('notesPage').classList.add('active');
    } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('settingsPage').classList.add('active');
        updateNoteCount();
    }
}

function loadNotes() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const notes = raw ? JSON.parse(raw) : [];
    renderNotes(notes);
}

function saveToStorage(notes) { localStorage.setItem(STORAGE_KEY, JSON.stringify(notes)); }

function renderNotes(notes) {
    const grid = document.getElementById('notesGrid');
    grid.innerHTML = '';
    if (!notes.length) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üóíÔ∏è</div><div>Keine Notizen. Erstelle eine neue Notiz.</div></div>';
        return;
    }
    notes.slice().reverse().forEach(note => {
        const card = document.createElement('div');
        card.className = 'note-card glass-card';
        card.innerHTML = `
            <div class="note-title">${escapeHtml(note.title || 'Ohne Titel')}</div>
            <div class="note-content">${escapeHtml(note.content || '')}</div>
            <div class="note-meta">
                <div>${new Date(note.updatedAt || note.createdAt).toLocaleString()}</div>
                <div class="note-actions">
                    <button onclick="editNote('${note.id}')">‚úèÔ∏è</button>
                    <button onclick="deleteNote('${note.id}')">üóëÔ∏è</button>
                </div>
            </div>`;
        grid.appendChild(card);
    });
}

function showEditor(id) {
    currentEditId = id || null;
    document.getElementById('editor').style.display = 'block';
    if (id) {
        const notes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const n = notes.find(x => x.id === id);
        if (n) {
            document.getElementById('noteTitle').value = n.title;
            document.getElementById('noteContent').value = n.content;
        }
    } else {
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteContent').value = '';
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
    document.getElementById('editor').style.display = 'none';
    currentEditId = null;
}

function saveNote() {
    const title = document.getElementById('noteTitle').value.trim();
    const content = document.getElementById('noteContent').value.trim();
    if (!title && !content) { alert('Bitte Titel oder Inhalt eingeben.'); return; }
    const notes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (currentEditId) {
        const idx = notes.findIndex(n => n.id === currentEditId);
        if (idx >= 0) {
            notes[idx].title = title;
            notes[idx].content = content;
            notes[idx].updatedAt = Date.now();
        }
    } else {
        notes.push({ id: 'n' + Date.now(), title, content, createdAt: Date.now(), updatedAt: Date.now() });
    }
    saveToStorage(notes);
    loadNotes();
    updateNoteCount();
    cancelEdit();
}

function editNote(id) { showEditor(id); }

function deleteNote(id) {
    if (!confirm('Notiz wirklich l√∂schen?')) return;
    let notes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    notes = notes.filter(n => n.id !== id);
    saveToStorage(notes);
    loadNotes();
    updateNoteCount();
}

function exportNotes() {
    const data = localStorage.getItem(STORAGE_KEY) || '[]';
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'notefy-notes.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

function importNotes(e) {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
        try {
            const parsed = JSON.parse(reader.result);
            if (!Array.isArray(parsed)) throw new Error('Ung√ºltiges Format');
            if (confirm('Import ersetzt aktuelle Notizen. Fortfahren?')) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
                loadNotes();
                updateNoteCount();
                alert('Import erfolgreich');
            }
        } catch (err) {
            alert('Import fehlgeschlagen: ' + err.message);
        }
    };
    reader.readAsText(f);
    e.target.value = '';
}

function changeAccentColor(el) {
    const color = el.dataset.primary;
    document.documentElement.style.setProperty('--primary', color);
    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    localStorage.setItem('accentColor', color);
}

function changeFontSize(v) {
    document.body.style.fontSize = v + 'px';
    document.getElementById('fontSizeLabel').textContent = v + 'px';
    localStorage.setItem('fontSize', v);
}

function changeLineHeight(v) {
    document.querySelectorAll('.note-content, textarea, body').forEach(el => el.style.lineHeight = v);
    document.getElementById('lineHeightLabel').textContent = v;
    localStorage.setItem('lineHeight', v);
}

function toggleMonospace() {
    const t = document.getElementById('monoToggle');
    const active = t.classList.toggle('active');
    document.querySelectorAll('.note-content, textarea, input[type="text"]').forEach(el => el.style.fontFamily = active ? "'Menlo', 'Consolas', monospace" : 'inherit');
    localStorage.setItem('monospace', active);
}

function changeColumns(v) {
    const grid = document.getElementById('notesGrid');
    if (v === 'auto') {
        grid.style.gridTemplateColumns = '';
        document.getElementById('columnsLabel').textContent = 'Automatisch';
    } else {
        grid.style.gridTemplateColumns = `repeat(${v},1fr)`;
        document.getElementById('columnsLabel').textContent = v + ' Spalten';
    }
    localStorage.setItem('columns', v);
}

function toggleCompactView() {
    const t = document.getElementById('compactToggle');
    const active = t.classList.toggle('active');
    document.querySelectorAll('.note-card').forEach(card => card.style.minHeight = active ? '120px' : '200px');
    localStorage.setItem('compact', active);
}

function clearAllNotes() {
    if (!confirm('Alle Notizen unwiderruflich l√∂schen?')) return;
    localStorage.removeItem(STORAGE_KEY);
    loadNotes();
    updateNoteCount();
}

function resetSettings() {
    if (!confirm('Einstellungen zur√ºcksetzen?')) return;
    ['darkMode','fontSize','lineHeight','monospace','columns','compact','accentColor'].forEach(k => localStorage.removeItem(k));
    location.reload();
}

function updateNoteCount() {
    const notes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    document.getElementById('noteCount').textContent = notes.length + ' Notizen';
}

function setupPWA() {
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const el = document.getElementById('installPrompt');
        if (el) el.style.display = 'block';
    });
}

async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            await navigator.serviceWorker.register('service-worker.js');
        } catch (e) {
            console.warn('SW registration failed', e);
        }
    }
}

function checkOnlineStatus() {
    const s = document.getElementById('status');
    const txt = document.getElementById('statusText');
    if (navigator.onLine) {
        s.classList.remove('offline');
        txt.textContent = 'Online - Bereit zum Notieren';
    } else {
        s.classList.add('offline');
        txt.textContent = 'Offline - √Ñnderungen werden lokal gespeichert';
    }
}

function installApp() {
    if (!deferredPrompt) { alert('Installation nicht verf√ºgbar'); return; }
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
        deferredPrompt = null;
        const el = document.getElementById('installPrompt');
        if (el) el.style.display = 'none';
    });
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// expose functions for inline handlers
window.showEditor = showEditor;
window.saveNote = saveNote;
window.cancelEdit = cancelEdit;
window.exportNotes = exportNotes;
window.importNotes = importNotes;
window.changeAccentColor = el => changeAccentColor(el);
window.changeFontSize = changeFontSize;
window.changeLineHeight = changeLineHeight;
window.toggleMonospace = toggleMonospace;
window.changeColumns = changeColumns;
window.toggleCompactView = toggleCompactView;
window.clearAllNotes = clearAllNotes;
window.resetSettings = resetSettings;
window.editNote = editNote;
window.deleteNote = deleteNote;

// apply saved settings on load
(function applySavedSettings(){
    const accent = localStorage.getItem('accentColor');
    if (accent) document.documentElement.style.setProperty('--primary', accent);
    const fs = localStorage.getItem('fontSize');
    if (fs) changeFontSize(fs);
    const lh = localStorage.getItem('lineHeight');
    if (lh) changeLineHeight(lh);
    if (localStorage.getItem('monospace') === 'true') toggleMonospace();
    const cols = localStorage.getItem('columns') || 'auto';
    changeColumns(cols);
    if (localStorage.getItem('compact') === 'true') toggleCompactView();
})();
</script>
</body>
</html>
